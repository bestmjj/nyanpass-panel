<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Nyanpass èšåˆé¢æ¿</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f8f9fa;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .job {
            background: white;
            padding: 16px;
            margin: 16px 0;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        input, button, select {
            padding: 6px 10px;
            margin: 4px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #0d6efd;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        button:hover {
            background: #0b5ed7;
        }
        button.delete {
            background: #dc3545;
        }
        button.delete:hover {
            background: #bb2d3b;
        }
        button.edit {
            background: #198754;
        }
        button.edit:hover {
            background: #157347;
        }
        .logout-btn {
            background: #ffc107;
            color: #212529;
            float: right;
            margin-bottom: 16px;
        }
        .logs {
            background: #212529;
            color: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin-top: 12px;
            font-family: ui-monospace, SFMono-Regular, 'Courier New', monospace;
            white-space: pre-wrap;
            font-size: 13px;
        }
        label {
            display: inline-block;
            width: 160px;
            font-weight: bold;
            margin-top: 4px;
        }
        input[type="text"],
        input[type="password"],
        input[type="number"] {
            width: 220px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }
        th, td {
            padding: 10px 8px;
            border: 1px solid #dee2e6;
            text-align: left;
        }
        th {
            background: #e9ecef;
            font-weight: 600;
        }
        .status-ok {
            color: #198754;
            font-weight: 500;
        }
        .dg-link {
            color: #0d6efd;
            text-decoration: none;
            cursor: help;
        }
        .dg-link:hover {
            text-decoration: underline;
        }
        h1, h2, h3 {
            color: #212529;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .modal-header h3 {
            margin: 0;
        }
        .modal-footer {
            margin-top: 16px;
            text-align: right;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>âš™ï¸ Nyanpass èšåˆé¢æ¿</h1>
    <button class="logout-btn" onclick="logout()">ğŸšª ç™»å‡º</button>
    <div style="clear: both;"></div>

    <div class="job">
        <h3>â• æ·»åŠ é…ç½®</h3>
        <p><label>åç§°:</label> <input type="text" id="new_name" value="é…ç½®"></p>
        <p><label>ç”¨æˆ·å:</label> <input type="text" id="new_username" required></p>
        <p><label>å¯†ç :</label> <input type="password" id="new_password" required></p>
        <p><label>é¢æ¿åœ°å€:</label> <input type="text" id="new_nya" placeholder="https://your-panel.com" value="https://nya.trp.sh"></p>
        <p><label>CF Token:</label> <input type="password" id="new_cf" placeholder="ç•™ç©ºåˆ™ä¸æ›´æ–° DNS"></p>
        <!-- ä¸»åŸŸåå·²åˆ é™¤ -->
        <p>
            <label>å‘¨æœŸ(åˆ†é’Ÿ):</label>
            <input type="number" id="new_interval" value="15" min="1">
            <label>
                <input type="checkbox" id="new_enabled" checked>
                å¯ç”¨
            </label>
        </p>
        <p><label>Telegram Bot Token:</label> <input type="password" id="new_tg_token" placeholder="123456:ABC..."></p>
        <p><label>Telegram Chat ID:</label> <input type="text" id="new_tg_chat" placeholder="123456789"></p>
        <button onclick="addJob()">âœ… æ·»åŠ </button>
    </div>

    <h2>ğŸ“‹ é…ç½®åˆ—è¡¨</h2>
    <div id="jobs"></div>

    <div style="margin-top: 20px;">
        <button id="saveAllBtn" onclick="saveAll()">ğŸ’¾ ä¿å­˜å¹¶åº”ç”¨é…ç½®</button>
        <button onclick="loadJobs()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
    </div>
</div>

<!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>âœï¸ ç¼–è¾‘é…ç½®</h3>
            <button onclick="closeEditModal()" style="background:#6c757d; padding:2px 8px;">Ã—</button>
        </div>
        <input type="hidden" id="edit_id">
        <p><label>åç§°:</label> <input type="text" id="edit_name"></p>
        <p><label>ç”¨æˆ·å:</label> <input type="text" id="edit_username" required></p>
        <p><label>å¯†ç :</label> <input type="password" id="edit_password" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹"></p>
        <p><label>é¢æ¿åœ°å€:</label> <input type="text" id="edit_nya" placeholder="https://your-panel.com"></p>
        <p><label>CF Token:</label> <input type="password" id="edit_cf" placeholder="ç•™ç©ºåˆ™ä¸æ›´æ–° DNS"></p>
        <!-- ä¸»åŸŸåå·²åˆ é™¤ -->
        <p>
            <label>å‘¨æœŸ(åˆ†é’Ÿ):</label>
            <input type="number" id="edit_interval" min="1">
            <label>
                <input type="checkbox" id="edit_enabled">
                å¯ç”¨
            </label>
        </p>
        <p><label>Telegram Bot Token:</label> <input type="password" id="edit_tg_token" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹"></p>
        <p><label>Telegram Chat ID:</label> <input type="text" id="edit_tg_chat" placeholder="123456789"></p>
        <div class="modal-footer">
            <button onclick="closeEditModal()" style="background:#6c757d;">å–æ¶ˆ</button>
            <button onclick="saveEdit()" class="edit">ğŸ’¾ ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- è®¾å¤‡ç»„è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="dgModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="dgModalTitle">è®¾å¤‡ç»„è¯¦æƒ…</h3>
      <button onclick="closeDgModal()" style="background:#6c757d; padding:2px 8px;">Ã—</button>
    </div>
    <pre id="dgModalContent" style="background:#f8f9fa; padding:12px; border-radius:6px; overflow:auto;"></pre>
    <div class="modal-footer">
      <button onclick="closeDgModal()" style="background:#6c757d;">å…³é—­</button>
    </div>
  </div>
</div>

<!-- åŸŸåç®¡ç†æ¨¡æ€æ¡† -->
<div id="domainModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="domainModalTitle">ç®¡ç†åŸŸå</h3>
      <button onclick="closeDomainModal()" style="background:#6c757d; padding:2px 8px;">Ã—</button>
    </div>
    <input type="hidden" id="domain_job_id">
    <input type="hidden" id="domain_rule_id">
    <p style="color:#666; margin-bottom:16px;">ä¸ºæ­¤è½¬å‘è§„åˆ™æ·»åŠ åŸŸåæ˜ å°„ï¼ŒIP å˜åŠ¨æ—¶è‡ªåŠ¨æ›´æ–° DNS</p>
    <div id="domainList" style="margin-bottom:16px;"></div>
    <div style="display:flex; gap:6px; margin-bottom:12px;">
      <input type="text" id="newDomain" placeholder="ä¾‹å¦‚: server1.example.com" style="flex:1;">
      <button onclick="addDomainToRule()">â• æ·»åŠ </button>
    </div>
    <div class="modal-footer">
      <button onclick="closeDomainModal()" style="background:#6c757d;">å…³é—­</button>
      <button onclick="saveDomainChanges()" class="edit">ğŸ’¾ ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
let jobs = {};

function logout() {
    if (confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) {
        window.location.href = '/logout';
    }
}

function addJob() {
    const name = document.getElementById('new_name').value.trim();
    const username = document.getElementById('new_username').value.trim();
    const password = document.getElementById('new_password').value;
    const nya_host = document.getElementById('new_nya').value.trim();
    const cf_token = document.getElementById('new_cf').value || undefined;
    // ä¸»åŸŸåå·²åˆ é™¤
    const interval = parseInt(document.getElementById('new_interval').value) || 15;
    const enabled = document.getElementById('new_enabled').checked;
    const tg_token = document.getElementById('new_tg_token').value || undefined;
    const tg_chat = document.getElementById('new_tg_chat').value || undefined;

    if (!username || !password) {
        alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
        return;
    }

    const job = {
        id: 'job_' + Date.now(),
        name: name || 'é…ç½®',
        username: username,
        password: password,
        nya_host: nya_host || 'https://nya.trp.sh',
        cf_token: cf_token,
        interval_minutes: interval,
        enabled: enabled,
        telegram_bot_token: tg_token,
        telegram_chat_id: tg_chat
    };

    jobs[job.id] = job;
    render();
}

function deleteJob(id) {
    if (confirm('ç¡®å®šåˆ é™¤æ­¤é…ç½®ï¼Ÿ')) {
        delete jobs[id];
        render();
    }
}

function editJob(id) {
    const job = jobs[id];
    if (!job) return;

    document.getElementById('edit_id').value = id;
    document.getElementById('edit_name').value = job.name;
    document.getElementById('edit_username').value = job.username;
    document.getElementById('edit_password').value = '';
    document.getElementById('edit_nya').value = job.nya_host;
    document.getElementById('edit_cf').value = job.cf_token || '';
    // ä¸»åŸŸåå·²åˆ é™¤
    document.getElementById('edit_interval').value = job.interval_minutes;
    document.getElementById('edit_enabled').checked = job.enabled;
    document.getElementById('edit_tg_token').value = job.telegram_bot_token || '';
    document.getElementById('edit_tg_chat').value = job.telegram_chat_id || '';
    document.getElementById('editModal').style.display = 'flex';
}

function saveEdit() {
    const id = document.getElementById('edit_id').value;
    if (!jobs[id]) return;

    const name = document.getElementById('edit_name').value.trim();
    const username = document.getElementById('edit_username').value.trim();
    let password = document.getElementById('edit_password').value;
    const nya_host = document.getElementById('edit_nya').value.trim();
    const cf_token = document.getElementById('edit_cf').value || undefined;
    const interval = parseInt(document.getElementById('edit_interval').value) || 15;
    const enabled = document.getElementById('edit_enabled').checked;
    const tg_token = document.getElementById('edit_tg_token').value || undefined;
    const tg_chat = document.getElementById('edit_tg_chat').value || undefined;

    if (!username) {
        alert('è¯·è¾“å…¥ç”¨æˆ·å');
        return;
    }

    if (password === '') {
        password = jobs[id].password;
    }

    const existing = jobs[id] || {};
    const preserved = {
        rule_domains: existing.rule_domains || {},
        last_ct_ip: existing.last_ct_ip || undefined
    };

    jobs[id] = {
        ...existing,
        name: name || 'é…ç½®',
        username: username,
        password: password,
        nya_host: nya_host || 'https://nya.trp.sh',
        cf_token: cf_token,
        interval_minutes: interval,
        enabled: enabled,
        telegram_bot_token: tg_token,
        telegram_chat_id: tg_chat,
        rule_domains: preserved.rule_domains,
        last_ct_ip: preserved.last_ct_ip
    };

    closeEditModal();
    render();
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

function runJob(id) {
    fetch(`/api/run/${id}`, { method: 'POST' })
        .then(res => {
            if (res.ok) {
                alert('ä»»åŠ¡å·²å¯åŠ¨');
            } else {
                alert('å¯åŠ¨å¤±è´¥');
            }
        })
        .catch(() => alert('è¯·æ±‚å¤±è´¥'));
}

function toggleLog(btn) {
    const log = btn.nextElementSibling;
    const isVisible = log.style.display === 'block';
    log.style.display = isVisible ? 'none' : 'block';
    if (!isVisible) {
        log.scrollTop = log.scrollHeight;
    }
}

function showDgDetail(jobId, dgId) {
    const job = jobs[jobId];
    if (!job || !job.device_groups) {
        alert('è®¾å¤‡ç»„æ•°æ®æœªåŠ è½½ï¼ˆè¯·å…ˆè¿è¡Œä¸€æ¬¡ä»»åŠ¡ï¼‰');
        return;
    }
    const dg = job.device_groups.find(g => g.id == dgId);
    if (!dg) {
        alert('æœªæ‰¾åˆ°è®¾å¤‡ç»„');
        return;
    }

    let configStr = dg.config || '';
    try {
        const parsed = JSON.parse(dg.config);
        configStr = JSON.stringify(parsed, null, 2);
    } catch (e) {}

    const content = [
        `ID: ${dg.id}`,
        `åç§°: ${dg.name}`,
        `ç±»å‹: ${dg.type}`,
        ...(dg.connect_host ? [`è¿æ¥ä¸»æœº:\n${dg.connect_host}`] : []),
        ...(dg.port_range ? [`ç«¯å£èŒƒå›´: ${dg.port_range}`] : []),
        ...(dg.note ? [`å¤‡æ³¨: ${dg.note}`] : []),
        ...(dg.ratio !== undefined ? [`æƒé‡: ${dg.ratio}`] : []),
        ...(dg.traffic_used !== undefined ? [`å·²ç”¨æµé‡: ${(dg.traffic_used / (1024**3)).toFixed(2)} GiB`] : []),
        ...(configStr ? [`é…ç½®:\n${configStr}`] : [])
    ].join('\n');

    document.getElementById('dgModalTitle').textContent = `è®¾å¤‡ç»„è¯¦æƒ…ï¼š${dg.name}`;
    document.getElementById('dgModalContent').textContent = content;
    document.getElementById('dgModal').style.display = 'flex';
}

function closeDgModal() {
    document.getElementById('dgModal').style.display = 'none';
}

// ===== åŸŸåç®¡ç† =====
let currentDomains = [];

function showDomainManager(jobId, ruleId, ruleName) {
    const modal = document.getElementById('domainModal');
    document.getElementById('domain_job_id').value = jobId;
    document.getElementById('domain_rule_id').value = ruleId;
    document.getElementById('domainModalTitle').textContent = `ç®¡ç†åŸŸå - ${ruleName}`;
    document.getElementById('newDomain').value = '';
    
    fetch(`/api/domains/${jobId}/${ruleId}`)
        .then(r => r.json())
        .then(d => {
            currentDomains = d.domains || [];
            renderDomainList();
            modal.style.display = 'flex';
        })
        .catch(e => {
            alert('åŠ è½½åŸŸåå¤±è´¥: ' + e);
            modal.style.display = 'flex';
        });
}

function renderDomainList() {
    const div = document.getElementById('domainList');
    if (currentDomains.length === 0) {
        div.innerHTML = '<p style="color:#999; text-align:center;">æš‚æ— åŸŸå</p>';
        return;
    }
    
    let html = '<div style="display:flex; flex-direction:column; gap:6px;">';
    currentDomains.forEach((domain, idx) => {
        html += `
            <div style="display:flex; justify-content:space-between; align-items:center; background:#f8f9fa; padding:8px; border-radius:4px; border-left:3px solid #0d6efd;">
                <span style="font-family:monospace;">${domain}</span>
                <button onclick="removeDomainFromRule(${idx})" style="background:#dc3545; padding:4px 8px; font-size:12px;">âœ• åˆ é™¤</button>
            </div>
        `;
    });
    html += '</div>';
    div.innerHTML = html;
}

function addDomainToRule() {
    const input = document.getElementById('newDomain');
    const domain = input.value.trim();
    
    if (!domain) {
        alert('è¯·è¾“å…¥åŸŸå');
        return;
    }
    
    if (currentDomains.includes(domain)) {
        alert('æ­¤åŸŸåå·²å­˜åœ¨');
        return;
    }
    
    currentDomains.push(domain);
    renderDomainList();
    input.value = '';
}

function removeDomainFromRule(idx) {
    currentDomains.splice(idx, 1);
    renderDomainList();
}

function saveDomainChanges() {
    const jobId = document.getElementById('domain_job_id').value;
    const ruleId = document.getElementById('domain_rule_id').value;
    const saveBtn = document.getElementById('saveAllBtn');
    if (saveBtn) saveBtn.disabled = true;
    fetch(`/api/domains/${jobId}/${ruleId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({domains: currentDomains})
    })
    .then(r => {
        if (!r.ok) return r.json().then(err => Promise.reject(err));
        return r.json();
    })
    .then(d => {
        if (!jobs[jobId]) jobs[jobId] = {};
        jobs[jobId].rule_domains = currentDomains.slice();
        alert('âœ… åŸŸåå·²ä¿å­˜');
        closeDomainModal();
        render();
    })
    .catch(e => {
        const msg = (e && e.error) ? (e.error + (e.invalid ? ': ' + e.invalid.join(',') : '')) : e;
        alert('ä¿å­˜å¤±è´¥: ' + msg);
    })
    .finally(() => {
        if (saveBtn) saveBtn.disabled = false;
    });
}

function closeDomainModal() {
    document.getElementById('domainModal').style.display = 'none';
    currentDomains = [];
}

function renderForwardRules(jobId, rules, deviceGroups) {
    if (!rules || rules.length === 0) return '<p>æš‚æ— è½¬å‘è§„åˆ™</p>';
    
    let html = `<table><thead><tr>
        <th>åç§°</th>
        <th>ç«¯å£</th>
        <th>ç›®æ ‡</th>
        <th>å…¥å£è®¾å¤‡ç»„</th>
        <th>çŠ¶æ€</th>
        <th>æµé‡ (GiB)</th>
        <th>æ›´æ–°æ—¶é—´</th>
        <th>æ“ä½œ</th>
    </tr></thead><tbody>`;
    
    rules.forEach(r => {
        const status = r.status === "ForwardRuleStatus_Normal" ? 
            '<span class="status-ok">âœ… æ­£å¸¸</span>' : r.status;
        
        let dgiDisplay = 'â€”';
        if (r.device_group_in != null) {
            const tooltip = r.device_group_connect ? r.device_group_connect.replace(/\n/g, ' | ') : '';
            dgiDisplay = `<a class="dg-link" href="#" onclick="showDgDetail('${jobId}', ${r.device_group_in}); return false;" title="${tooltip}">${r.device_group_name}</a>`;
        }

        html += `<tr>
            <td>${r.name}</td>
            <td>${r.listen_port}</td>
            <td>${r.dest}</td>
            <td>${dgiDisplay}</td>
            <td>${status}</td>
            <td>${r.traffic_gib}</td>
            <td>${r.updated_at}</td>
            <td><button class="edit" onclick="showDomainManager('${jobId}', '${r.id}', '${r.name}')">ğŸ”— åŸŸå</button></td>
        </tr>`;
    });
    html += '</tbody></table>';
    return html;
}

function render() {
    const div = document.getElementById('jobs');
    div.innerHTML = '';
    for (const [id, job] of Object.entries(jobs)) {
        const tgInfo = job.telegram_chat_id ? `Telegram: ${job.telegram_chat_id}` : 'æ—  Telegram é€šçŸ¥';
        // DNS ä¿¡æ¯ä¸å†æ˜¾ç¤ºä¸»åŸŸå
        const userInfo = job.user_info ? `<pre style="background:#f1f3f5;padding:10px;border-radius:4px;">${job.user_info}</pre>` : '';
        const forwardTable = job.forward_rules ? renderForwardRules(id, job.forward_rules, job.device_groups) : '';
        div.innerHTML += `
            <div class="job">
                <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;">
                    <div style="flex:1;min-width:300px;">
                        <strong>${job.name}</strong> (${job.username})<br>
                        é¢æ¿åœ°å€: <a href="${job.nya_host}" target="_blank">${job.nya_host}</a><br>
                        ${tgInfo}<br>
                        å‘¨æœŸ: ${job.interval_minutes} åˆ†é’Ÿ ${job.enabled ? 'âœ…' : 'âŒ'}<br>
                        æœ€åæ‰§è¡Œ: ${job.last_run || 'ä»æœª'}
                    </div>
                    <div style="display:flex;gap:6px;flex-wrap:wrap;">
                        <button onclick="runJob('${id}')">â–¶ï¸ è¿è¡Œ</button>
                        <button class="edit" onclick="editJob('${id}')">âœï¸ ç¼–è¾‘</button>
                        <button class="delete" onclick="deleteJob('${id}')">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </div>
                ${userInfo}
                ${forwardTable}
                ${job.last_log ? `<button onclick="toggleLog(this)">ğŸ“œ æ—¥å¿—</button><div class="logs" style="display:none;">${job.last_log}</div>` : ''}
            </div>
        `;
    }
}

function saveAll() {
    fetch('/api/config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({jobs})
    }).then(res => {
        if (res.ok) {
            alert('âœ… é…ç½®å·²ä¿å­˜å¹¶åº”ç”¨');
        } else {
            alert('âŒ ä¿å­˜å¤±è´¥');
        }
    }).catch(e => alert('ç½‘ç»œé”™è¯¯: ' + e));
}

function loadJobs() {
    fetch('/api/config')
        .then(r => r.json())
        .then(d => { 
            jobs = d.jobs || {}; 
            render(); 
        })
        .catch(e => { 
            alert('åŠ è½½å¤±è´¥: ' + e); 
            jobs = {}; 
            render(); 
        });
}

document.addEventListener('DOMContentLoaded', function() {
    loadJobs();
});

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        closeEditModal();
        closeDgModal();
    }
};
</script>
</body>
</html>